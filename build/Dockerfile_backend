FROM rust:slim-bookworm@sha256:de22cea71b620c7fdc61e8c1bf3f048d0ffbafe062ca9d7b32aed6a7d59109a4

ENV CANISTER_NAME=gldt_core

RUN apt update > /dev/null && \
    apt install -y wget build-essential pkg-config libssl-dev > /dev/null
RUN rustup component add clippy
RUN rustup target add wasm32-unknown-unknown
RUN mkdir -pv .cargo 
RUN cargo install -q --root .cargo ic-wasm@0.5.0 candid-extractor cargo-tarpaulin

ENV PATH="/.cargo/bin:$PATH"

COPY . /builds/gldt/gldt-swap

WORKDIR /builds/gldt/gldt-swap

CMD ./scripts/build-canister.sh --wasmonly $CANISTER_NAME && \
    ./scripts/generate-did.sh $CANISTER_NAME && \
    ./scripts/build-canister.sh $CANISTER_NAME
