default:
  image: registry.bochslerfinance.com/runners-images/dfinity-canisters:0.14.3@sha256:ae4a62ea83e1eaaebab3e5186b2a3b67ba8d45951719b6acdda5fa7bcd13376e
  tags:
    - docker
  interruptible: true
  before_script:
    - dfx --version
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - api_failure
      - runner_unsupported
      - unknown_failure

cache:
  - key: "dfx-$CI_COMMIT_REF_SLUG"
    paths:
      - .dfx

stages:
  - lint
  - test
  - build
  - deploy

###############################################################################
# Templates
###############################################################################
.node template: &node_template
  image: node:18
  cache:
  - key: "node-$CI_COMMIT_REF_SLUG"
    paths:
      - .npm/
      - node_modules/
      - swap_app/.next/
      - swap_app/.npm/
      - swap_app/node_modules/
  before_script:
    - apt update -q > /dev/null && apt install -y jq > /dev/null
    - npm ci --cache .npm --prefer-offline

.rust template: &rust_template
  image: rust:slim-bookworm
  cache:
  - key: "rust-$CI_COMMIT_REF_SLUG"
    paths:
      - .cargo
      - canister/gldt_core/target
  before_script:
    - apt update > /dev/null && apt install -y wget build-essential > /dev/null
    - rustup component add clippy
    - rustup target add wasm32-unknown-unknown
    - mkdir -pv .cargo
    - cargo install -q --root .cargo ic-wasm@0.5.0 candid-extractor
    - export PATH="$PWD/.cargo/bin:$PATH"

################################################################################
# Linters
################################################################################
swap_app linter:
  stage: lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "client/swap_app/*.{js,json}"
        - "client/swap_app/{**,**/**,**/**/**}/*.{js,jsx,md,mdx,css,html,svg}"
    - if: $CI_COMMIT_REF_NAME == "develop"
  <<: *node_template
  script:
    - npm run lint:swap_app

landing_page linter:
  stage: lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "client/landing_page/*.{js,json}"
        - "client/landing_page/{**,**/**,**/**/**}/*.{js,jsx,md,mdx,css,html,svg}"
    - if: $CI_COMMIT_REF_NAME == "develop"
  <<: *node_template
  script:
    - npm run lint:landing_page

.explorer linter:
  stage: lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "client/explorer/*.{js,json}"
        - "client/explorer/{**,**/**,**/**/**}/*.{js,jsx,md,mdx,css,html,svg}"
    - if: $CI_COMMIT_REF_NAME == "develop"
  <<: *node_template
  script:
    - npm run lint:explorer

rust lint:
  stage: lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "Cargo.{lock,toml}"
        - "canister/{gldt_core,gldt_core/src,gldt_core/src/**}/*.{rs,toml,lock}"
    - if: $CI_COMMIT_REF_NAME == "develop"
  <<: *rust_template
  script:
    - cargo clippy

################################################################################
# Tests
################################################################################
gldt_core test build:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  <<: *rust_template
  script:
    - scripts/build-canister.sh gldt_core
    - ic-wasm canister/gldt_core/target/wasm32-unknown-unknown/release/gldt_core_canister.wasm info
    - scripts/generate-did.sh gldt_core
  artifacts:
    name: "gldt_core-${CI_COMMIT_SHORT_SHA}-wasm-TEST_BUILD"
    paths:
      - canister/gldt_core/target/wasm32-unknown-unknown/release
      - canister/gldt_core/src/gldt_core.did
    expire_in: 1 day

.gldt_fee_compensation test build:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  <<: *rust_template
  script:
    - scripts/build-canister.sh gldt_fee_compensation
    - ic-wasm canister/gldt_core/target/wasm32-unknown-unknown/release/gldt_fee_compensation_canister.wasm info
    - scripts/generate-did.sh gldt_fee_compensation
  artifacts:
    name: "gldt_fee_compensation-${CI_COMMIT_SHORT_SHA}-wasm-TEST_BUILD"
    paths:
      - canister/gldt_fee_compensation/target/wasm32-unknown-unknown/release
      - canister/gldt_fee_compensation/src/gldt_fee_compensation.did
    expire_in: 1 day

generate test declarations:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      needs: ["canister test build"]
  script:
    - dfx generate
    - mv canister/gld_nft/declarations/gldnft_backend_1g.did.js canister/gld_nft/declarations/gld_nft.did.js
    - mv canister/gld_nft/declarations/gldnft_backend_1g.did canister/gld_nft/declarations/gld_nft.did
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}-TEST-declarations"
    paths:
      - canister/**/declarations
    expire_in: 1 day

nextjs test build:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs: ["canister test build", "generate test declarations"]
  <<: *node_template
  script:
    - npm run build:swap_app
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-frontend-TEST"
    paths:
      - swap_app/out
    expire_in: 1 day

################################################################################
# Builds
################################################################################
gldt_core canister build:
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME == "develop" || $CI_COMMIT_REF_NAME == "master"
  <<: *rust_template
  script:
    - scripts/build-canister.sh gldt_core
    - scripts/generate-did.sh gldt_core
  artifacts:
    name: "${CI_PROJECT_NAME}-gldt_core-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-wasm"
    paths:
      - canister/gldt_core/target/wasm32-unknown-unknown/release
      - canister/gldt_core/src/gldt_core.did
    expire_in: 6 months

gldt_fee_compensation canister build:
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME == "develop" || $CI_COMMIT_REF_NAME == "master"
  <<: *rust_template
  script:
    - scripts/build-canister.sh gldt_fee_compensation
    - scripts/generate-did.sh gldt_fee_compensation
  artifacts:
    name: "${CI_PROJECT_NAME}-gldt_fee_compensation-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-wasm"
    paths:
      - canister/gldt_fee_compensation/target/wasm32-unknown-unknown/release
      - canister/gldt_fee_compensation/src/gldt_fee_compensation.did
    expire_in: 6 months

generate declarations:
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME == "develop" || $CI_COMMIT_REF_NAME == "master"
      needs: ["canister build"]
  script:
    - dfx generate
    - mv canister/gld_nft/declarations/gldnft_backend_1g.did.js canister/gld_nft/declarations/gld_nft.did.js
    - mv canister/gld_nft/declarations/gldnft_backend_1g.did canister/gld_nft/declarations/gld_nft.did
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}-declarations"
    paths:
      - canister/**/declarations
    expire_in: 6 months

swap_app staging build:
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME == "develop"
  # TODO: add "gldt_fee_compensation canister build" as needed ?
  needs: ["gldt_core canister build", "generate declarations"]
  <<: *node_template
  script:
    - npm run build:swap_app
    - STAGING_URL=https://$(jq -r '."gldt_swap_app".staging' canister_ids.json).icp0.io
    - echo "SWAP_APP_URL=$STAGING_URL" > swap_deploy.env
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}-swap_app_STAGING_BUILD"
    paths:
      - swap_app/out
    reports:
      dotenv: deploy.env
    expire_in: 1 day
  environment:
    name: swap_app
    deployment_tier: staging
    action: prepare

landing staging build:
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME == "develop"
  # TODO: add "gldt_fee_compensation canister build" as needed ?
  needs: ["gldt_core canister build", "generate declarations"]
  <<: *node_template
  script:
    - npm run build:landing
    - STAGING_URL=https://$(jq -r '."gldt_landing_page".staging' canister_ids.json).icp0.io
    - echo "LANDING_URL=$STAGING_URL" > deploy.env
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}-landing_STAGING_BUILD"
    paths:
      - landing/out
    reports:
      dotenv: deploy.env
    expire_in: 1 day
  environment:
    name: landing
    deployment_tier: staging
    action: prepare

explorer staging build:
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME == "develop"
  # TODO: add "gldt_fee_compensation canister build" as needed ?
  needs: ["gldt_core canister build", "generate declarations"]
  <<: *node_template
  script:
    - npm run build:explorer
    - STAGING_URL=https://$(jq -r '."gldt_explorer".staging' canister_ids.json).icp0.io
    - echo "EXPLORER_URL=$STAGING_URL" > deploy.env
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}-explorer_STAGING_BUILD"
    paths:
      - explorer/out
    reports:
      dotenv: deploy.env
    expire_in: 1 day
  environment:
    name: explorer
    deployment_tier: staging
    action: prepare

swap_app production build:
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME == "master"
      changes:
        - "swap_app/*.{js,json}"
        - "swap_app/{**,**/**,**/**/**}/*.{js,jsx,md,mdx,css,html,svg}"
  # TODO: add "gldt_fee_compensation canister build" as needed ?
  needs: ["gldt_core canister build", "generate declarations"]
  <<: *node_template
  script:
    - npm run build:swap_app
    - PRODUCTION_URL=https://$(jq -r '."gldt_swap_app".ic' canister_ids.json).icp0.io
    - echo "SWAP_APP_URL=$PRODUCTION_URL" > deploy.env
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-swap_app"
    paths:
      - swap_app/out
    reports:
      dotenv: deploy.env
    expire_in: 6 months
  environment:
    name: production
    action: prepare

landing_page production build:
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME == "master"
      changes:
        - "landing_page/*.{js,json}"
        - "landing_page/{**,**/**,**/**/**}/*.{js,jsx,md,mdx,css,html,svg}"
  # TODO: add "gldt_fee_compensation canister build" as needed ?
  needs: ["gldt_core canister build", "generate declarations"]
  <<: *node_template
  script:
    - npm run build:landing_page
    - PRODUCTION_URL=https://$(jq -r '."gldt_landing_page".ic' canister_ids.json).icp0.io
    - echo "LANDING_URL=$PRODUCTION_URL" > deploy.env
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-landing_page"
    paths:
      - landing_page/out
    reports:
      dotenv: deploy.env
    expire_in: 6 months
  environment:
    name: production
    action: prepare

explorer production build:
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME == "master"
      changes:
        - "explorer/*.{js,json}"
        - "explorer/{**,**/**,**/**/**}/*.{js,jsx,md,mdx,css,html,svg}"
  # TODO: add "gldt_fee_compensation canister build" as needed ?
  needs: ["gldt_core canister build", "generate declarations"]
  <<: *node_template
  script:
    - npm run build:explorer
    - PRODUCTION_URL=https://$(jq -r '."gldt_explorer".ic' canister_ids.json).icp0.io
    - echo "EXPLORER_URL=$PRODUCTION_URL" > deploy.env
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-explorer"
    paths:
      - explorer/out
    reports:
      dotenv: deploy.env
    expire_in: 6 months
  environment:
    name: production
    action: prepare

################################################################################
# Deployments
################################################################################
local deploy and tests:
  stage: deploy
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      needs: ["canister test build", "nextjs test build"]
  before_script:
    - dfx --version
    - dfx start --clean --background
  script:
    - scripts/local-deploy.sh
  after_script:
    - cat canister_ids.json
    - dfx stop

gldt frontend:
  stage: deploy
  rules:
    - if: $CI_COMMIT_REF_NAME == "develop"
      needs: ["next staging build"]
      variables:
        TARGET_NETWORK: staging
        ENVIRONMENT_NAME: "frontend staging"
        PEM_FILE: $PEM_FILE_STAGING
    - if: $CI_COMMIT_TAG =~ '/^swap_app-v\d+\.\d+\.\d+$/'
      needs: ["next production build"]
      variables:
        TARGET_NETWORK: ic
        ENVIRONMENT_NAME: "frontend production"
        PEM_FILE: $PEM_FILE_PRODUCTION
  before_script:
    - dfx --version
    - dfx identity import --storage-mode plaintext gitlab-ci-gldt $PEM_FILE
    - dfx identity use gitlab-ci-gldt
    - dfx identity whoami
  script:
    - dfx deploy --network $TARGET_NETWORK --no-wallet -y gldt_swap_app
  environment:
    name: $ENVIRONMENT_NAME
    url: $FRONTEND_URL
    action: start

gldt core:
  stage: deploy
  rules:
    - if: $CI_COMMIT_REF_NAME == "develop"
      variables:
        TARGET_NETWORK: staging
        ENVIRONMENT_NAME: "core staging"
        PEM_FILE: $PEM_FILE_STAGING
    - if: $CI_COMMIT_TAG =~ '/^core-v\d+\.\d+\.\d+$/'
      variables:
        TARGET_NETWORK: ic
        ENVIRONMENT_NAME: "core production"
        PEM_FILE: $PEM_FILE_PRODUCTION
  needs: ["canister build"]
  before_script:
    - dfx --version
    - dfx identity import --storage-mode plaintext gitlab-ci-gldt $PEM_FILE
    - dfx identity use gitlab-ci-gldt
    - dfx identity whoami
  script:
    - scripts/deploy-gldt-core.sh $TARGET_NETWORK
  environment:
    name: $ENVIRONMENT_NAME
    url: https://$(jq -r '."gldt_core".${TARGET_NETWORK}' canister_ids.json).icp0.io
    action: start

gldt ledger:
  stage: deploy
  rules:
    - if: $CI_COMMIT_REF_NAME == "develop"
      variables:
        TARGET_NETWORK: staging
        ENVIRONMENT_NAME: "ledger staging"
        PEM_FILE: $PEM_FILE_STAGING
    - if: $CI_COMMIT_TAG =~ '/^ledger-v\d+\.\d+\.\d+$/'
      when: manual
      variables:
        TARGET_NETWORK: ic
        ENVIRONMENT_NAME: "ledger production"
        PEM_FILE: $PEM_FILE_PRODUCTION
  before_script:
    - dfx --version
    - dfx identity import --storage-mode plaintext gitlab-ci-gldt $PEM_FILE
    - dfx identity use gitlab-ci-gldt
    - dfx identity whoami
  script:
    - scripts/deploy-ledger.sh $TARGET_NETWORK
  environment:
    name: $ENVIRONMENT_NAME
    url: https://$(jq -r '."gldt_ledger".${TARGET_NETWORK}' canister_ids.json).icp0.io
    action: start
