default:
  image: registry.bochslerfinance.com/runners-images/dfinity-canisters:0.17.0@sha256:5c939c840efdca76e885a5b89b77172ed04404faa770c74632005262e1bcc698
  tags:
    - docker
  interruptible: true
  before_script:
    - dfx --version
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - api_failure
      - runner_unsupported
      - unknown_failure

stages:
  - preparation
  - lint
  - test
  - build
  - deploy

include:
  # Canister builds
  - local: scripts/ci-cd/.canister_builds.yml
    inputs:
      src-folder: gldt_core

.rust template: &rust_template
  tags:
    - docker
    - big
  image: rust:slim-bookworm@sha256:de22cea71b620c7fdc61e8c1bf3f048d0ffbafe062ca9d7b32aed6a7d59109a4
  # cache:
  # - key: "rust-$CI_COMMIT_REF_SLUG"
  #   paths:
  #     - .cargo
  #     - backend/canisters/gldt_core/target
  #     - backend/canisters/gldt_fee_compensation/target
  before_script:
    - apt update > /dev/null && apt install -y wget build-essential pkg-config libssl-dev > /dev/null
    - rustup component add clippy
    - rustup target add wasm32-unknown-unknown
    - mkdir -pv .cargo
    - cargo install -q --root .cargo ic-wasm@0.5.0 candid-extractor cargo-tarpaulin
    - export PATH="$PWD/.cargo/bin:$PATH"
